{% extends 'correspondencia/base_correspondencia.html' %}
{% load static %}
{% block view_anteproyecto %}
  <style>
    .content_correspondecia {
      display: none;
    }
    .views {
      display: flex;
    }
    .info_anteproyecto {
      display: grid;
      grid-gap: 12px;
    }
    
    .img-users {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 50%;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .section_anteproyecto {
      z-index: 100;
      overflow: hidden;
    }
    .info-integrantes-ante {
      z-index: 0;
    }
    
    /* Mejora la responsividad */
    @media (max-width: 768px) {
      .info_anteproyecto {
        grid-template-columns: 1fr; /* Columna única en pantallas pequeñas */
      }
    
      .form-group.row {
        flex-direction: column; /* Colocar los elementos en columna */
      }
    
      .col {
        margin-bottom: 1rem; /* Espaciado entre columnas */
      }
    }
    .form_retroalimentacion {
      position: absolute;
      box-shadow: 0px 0px 11px 0px #636363;
      border: 1px solid #cacaca;
      border-radius: 12px;
      padding: 12px;
      background: #ffffff;
      top: 5%;
      transition: all 0.5s;
      z-index: 200;
      max-width: 100%; /* Ajustar ancho máximo */
      text-align: left; /* Agregado */
    }
    
    #formDirectores {
      transition: all 0.5s;
      right: -1000px; /* Posición fuera de la pantalla inicialmente */
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 100%;
      text-align: left; /* Agregado */
      z-index: 1000;
    }
    
    #formDirectores h5 {
      margin-bottom: 20px;
      text-align: left; /* Agregado */
    }
    
    #formDirectores .font-weight-bold {
      font-weight: bold;
      text-align: left; /* Agregado */
    }
    
    #formDirectores .btn-primary {
      background-color: #007bff;
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      text-align: left; /* Agregado */
    }
    
    #formDirectores .btn-outline-danger {
      border: 1px solid #dc3545;
      border-radius: 4px;
      color: #dc3545;
      font-weight: bold;
      text-align: left; /* Agregado */
    }
    
    /* Clase específica para el formulario modal */
    .form-formconcepto-modal {
      width: 100%;
      max-width: 500px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #f8f9fa; /* Fondo claro */
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 0;
      opacity: 0;
    }
    .form-retoalimentacion-modal {
      width: 100%;
      max-width: 500px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #f8f9fa; /* Fondo claro */
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 0;
      opacity: 0;
    }
    
    .form-directores-description {
      font-size: 0.95rem;
      color: #6c757d; /* Color de texto sutil */
      margin-bottom: 1rem; /* Espacio debajo de la descripción */
      text-align: center; /* Centrar el texto */
    }
    /* Estilo para el título del formulario */
    .form-directores-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #343a40;
      text-align: center;
    }
    
    /* Contenedor de los elementos del formulario */
    .form-directores-container {
      padding: 10px;
    }
    
    /* Estilo para cada ítem (director) */
    .form-directores-item {
      padding: 8px 0;
    }
    
    /* Estilo para las etiquetas de los directores */
    .form-directores-label {
      font-size: 1rem;
      color: #495057;
      margin-right: 10px;
    }
    
    /* Estilo para los checkboxes */
    .form-directores-checkbox {
      transform: scale(1.2);
      accent-color: #007bff;
    }
    
    /* Acciones (botones) del formulario */
    .form-directores-actions {
      margin-top: 20px;
    }
    
    /* Estilo del botón de enviar */
    .form-directores-submit {
      background-color: #007bff;
      border: none;
      border-radius: 5px;
      font-size: 1.1rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    
    /* Efecto hover para el botón de enviar */
    .form-directores-submit:hover {
      transform: scale(1.05);
    }
    
    /* Estilo del botón de cancelar */
    .form-directores-cancel {
      border: 1px solid #dc3545;
      color: #dc3545;
      border-radius: 5px;
      font-size: 1.1rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    
    /* Efecto hover para el botón de cancelar */
    .form-directores-cancel:hover {
      background-color: #f8d7da;
      transform: scale(1.05);
    }
    
    /* Spinner de carga oculto inicialmente */
    .spinner-border {
      margin-right: 8px;
    }
  </style>
  <section class="container section_anteproyecto mt-3 d-flex justify-content-center align-items-center position-relative">
    <div class="row info_anteproyecto d-flex">
      <h2>Proyecto: {{ inf_anteproyecto.anteproyecto.nombre_anteproyecto }}</h2>
      <h4>Información de la solicitud</h4>
      <div class="container-fluid d-flex flex-column flex-md-row">
        <div class="col mt-2 p-2">
          <p class="m-0 p-0 text-center">
            <strong class="text-center">Información del proyecto</strong>
          </p>
          <p class="m-0 p-0">
            <br />
            <strong>Nombre del proyecto:</strong> {{ inf_anteproyecto.anteproyecto.nombre_anteproyecto }}
            <br />
            <strong>Descripción:</strong> {{ inf_anteproyecto.anteproyecto.descripcion }}
          </p>
          <strong>Documentos cargados:</strong>
          <br />
          <ol>
            <li>
              <a class="" href="data:application/pdf;base64,{{ doc_carta }}" download="CartaPresentacion {{ inf_anteproyecto.anteproyecto.nombre_anteproyecto }}.pdf">Carta de solicitud del proyecto {{ inf_anteproyecto.anteproyecto.nombre_anteproyecto }}</a>
            </li>
            <li>
              <a class="" href="data:application/pdf;base64,{{ doc_anteproyecto }}" download="Anteproyecto {{ inf_anteproyecto.anteproyecto.nombre_anteproyecto }}.pdf">Anteproyecto {{ inf_anteproyecto.anteproyecto.nombre_anteproyecto }}</a>
            </li>
          </ol>
          {% if evaluaciones %}
            <div class="">
              <button id="btn-asignar" class="btn btn-primary mt-2 mb-3">Asignar docente evaluador</button>
              <p class="m-0 p-0 text-center">
                <strong class="text-center">Directores o director asignado</strong>
              </p>
              {% for evaluacion in evaluaciones %}
                <div class="list-group-item">
                  <h6 class="mb-1">{{ evaluacion.evaluador.nombre_completo }}</h6>
                  <small><strong>Fecha de asignación:</strong>{{ evaluacion.fecha_asignacion }}</small>
                  {% if evaluacion.comentarios %}
                    <p class="mb-1">
                      <strong>Comentarios:</strong> {{ evaluacion.comentarios }}
                    </p>
                    <p class="mb-1">
                      <strong>Calificación:</strong> {{ evaluacion.calificacion }}
                    </p>
                    <p class="mb-1">
                      <strong>Fecha de Evaluación:</strong> {{ evaluacion.fecha_evaluacion }}
                    </p>
                  {% else %}
                    <p class="mb-1 text-muted">Aún no se ha dado una evaluación</p>
                  {% endif %}
                </div>
              {% endfor %}
              <button class="btn btn-primary btn-concepto" style="text-decoration: none;">Enviar concepto de anteproyecto</button>
            </div>
          {% else %}
            <button id="btn-asignar" class="btn btn-primary">Asignar docente evaluador</button>
          {% endif %}
        </div>
        <div class="info-integrantes-ante col mt-2 p-2">
          <p class="text-center">
            <strong>Miembros</strong>
          </p>
          {% for key, integrante in datos_integrantes.items %}
            <div class="d-flex mb-1">
              {% if integrante.imagen %}
                <img class="img-users" src="data:image/jpeg;base64,{{ integrante.imagen }}" alt="Imagen de usuario" />
              {% else %}
                <img class="img-users" src="{% static 'icons/usuario.png' %}" alt="Imagen de usuario" />
              {% endif %}
              <p class="m-1">
                {{ integrante.nombre }}<br />
                <strong>{{ integrante.grupo }}</strong>
              </p>
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="container-fluid col mt-4">
        {% if documento_radicado %}
          <div class="p-4">
            <h4 class="">Radicado ya enviado</h4>
            <p>
              El radicado ya ha sido enviado al anteproyecto <strong>{{ inf_anteproyecto.anteproyecto.nombre_anteproyecto }}</strong>.
            </p>

            <!-- Enlace para descargar el PDF -->
            <a class="btn btn-primary mb-3" href="data:application/pdf;base64,{{ documento_radicado }}" download="Radicado_{{ inf_anteproyecto.anteproyecto.nombre_anteproyecto }}.pdf">Descargar Radicado</a>

            <!-- Vista previa del PDF embebido -->
            <div class="border p-2">
              <embed src="data:application/pdf;base64,{{ documento_radicado }}" type="application/pdf" width="100%" height="400px" />
            </div>

            <hr />
            <p class="mb-0">Si necesita hacer algún cambio, por favor actualice el documento.</p>
            <form id="radicadoForm" action="{% url 'correspondencia:editar_radicado' inf_anteproyecto.anteproyecto.id %}" method="POST" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="mb-3">
                <label for="pdfFile" class="form-label">Carga el radicado</label>
                <input class="form-control" type="file" id="pdfFile" name="documento_radicado" accept="application/pdf" required />
                <small class="form-text text-muted">Por favor, sube el archivo en formato PDF que contenga el radicado correspondiente.</small>
              </div>
              <button type="button" class="btn btn-success" id="submitBtn">Subir Documento</button>
            </form>
          </div>
        {% else %}
          <h3>Enviar radicado al proyecto "{{ inf_anteproyecto.anteproyecto.nombre_anteproyecto }}"</h3>
          <form id="radicadoForm" action="{% url 'correspondencia:cargar_radicado' inf_anteproyecto.anteproyecto.id %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-3">
              <label for="pdfFile" class="form-label">Carga el radicado</label>
              <input class="form-control" type="file" id="pdfFile" name="documento_radicado" accept="application/pdf" required />
              <small class="form-text text-muted">Por favor, sube el archivo en formato PDF que contenga el radicado correspondiente.</small>
            </div>
            <button type="button" class="btn btn-success" id="submitBtn">Subir Documento</button>
          </form>
        {% endif %}
      </div>
      {% comment %} <div class="col container-fluid mt-4"></div> {% endcomment %}

      <div id="formDirectores" class="form-retoalimentacion-modal position-absolute mt-2 p-4">
        <h5 class="form-directores-title">Seleccionar Directores</h5>

        <!-- Descripción añadida -->
        <p class="form-directores-description">Selecciona uno o más directores para asignar a este proyecto. Puedes elegir varios si es necesario.</p>

        <form id="directoresForm" action="{% url 'correspondencia:asignar_evaluadores_ante' inf_anteproyecto.anteproyecto.id %}" class="needs-validation form-directores-form" novalidate method="post">
          {% csrf_token %}

          <div class="form-directores-container">
            {% for director in directores %}
              <div class="form-directores-item d-flex justify-content-between align-items-center mb-3">
                <label for="{{ director.nombre_completo }}" class="form-directores-label">{{ director.nombre_completo }}</label>
                <input type="checkbox" name="directores" id="{{ director.nombre_completo }}" value="{{ director.id }}" class="form-directores-checkbox" />
              </div>
            {% endfor %}
          </div>

          <div class="form-directores-actions d-flex justify-content-center mt-4 gap-3">
            <button type="submit" id="btnEnviarDirectores" class="btn form-directores-submit px-5 py-2">
              <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
              Enviar
            </button>
            <button type="button" id="btn-cerrar-directores" class="btn form-directores-cancel px-5 py-2">Cancelar</button>
          </div>
        </form>
      </div>
      <div id="formconcepto" class="form-formconcepto-modal position-absolute mt-2 p-4">
        <h3>Enviar Concepto de Anteproyecto</h3>
        <form class="container-fluid p-2" action="{% url 'correspondencia:enviar_retroalimentacion' inf_anteproyecto.anteproyecto.nombre_anteproyecto %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="form-group row m-3">
            <label class="p-0 m-0" for="id_retroalimentacion"><strong>Concepto:</strong></label>
            {{ inf_anteproyecto.form_retroalimentacion.retroalimentacion }}
            <small class="form-text text-muted">Por favor, proporciona un resumen claro y conciso del concepto.</small>
          </div>

          <div class="row container-fluid mt-2">
            <div class="form-group col-12 col-md-6 m-2">
              <label class="p-0 m-0" for="id_doc_retroalimentacion"><strong>Documento de Concepto:</strong></label>
              {{ inf_anteproyecto.form_retroalimentacion.doc_retroalimentacion_convert }}
              <small class="form-text text-muted">Sube un archivo PDF que contenga el concepto.</small>
            </div>

            <div class="form-group col-12 col-md-6 m-2">
              <label class="p-0 m-0" for="id_estado"><strong>Estado:</strong></label>
              {{ inf_anteproyecto.form_retroalimentacion.estado }}
              <small class="form-text text-muted">Selecciona el estado correspondiente al concepto.</small>
            </div>
          </div>

          <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-primary">Enviar</button>
            <button id="btn-cerrar-concepto" class="btn btn-danger">Cerrar</button>
          </div>
        </form>
      </div>
    </div>
  </section>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('btn-asignar').addEventListener('click', function () {
        const formdirectores = document.getElementById('formDirectores')
        formdirectores.style.position = 'fixed'
        formdirectores.style.top = '50%'
        formdirectores.style.left = '50%'
        formdirectores.style.transform = 'translate(-50%, -50%)'
        formdirectores.style.transition = 'opacity 0.5s'
        formdirectores.style.opacity = '1'
        formdirectores.style.zIndex = '1000'
      })
    
      document.getElementById('btn-cerrar-directores').addEventListener('click', function () {
        const formdirectores = document.getElementById('formDirectores')
        console.log('funcionando')
        formdirectores.style.opacity = '0'
        formdirectores.style.transition = 'opacity 0.5s'
    
        setTimeout(() => {
          formdirectores.style.zIndex = '-1'
          formdirectores.style.position = 'absolute'
        }, 500)
      })
    
      document.getElementById('directoresForm').addEventListener('submit', function (event) {
        event.preventDefault() // Prevenir el envío predeterminado
    
        const form = event.target
    
        // Verificar si el formulario es válido
        if (!form.checkValidity()) {
          event.stopPropagation()
          form.classList.add('was-validated') // Mostrar errores de validación
          Swal.fire({
            icon: 'error',
            title: 'Formulario incompleto',
            text: 'Por favor, complete todos los campos requeridos antes de enviar.'
          })
          return
        }
    
        Swal.fire({
          title: '¿Está seguro de que desea enviar?',
          text: 'Una vez enviado, no podrá cambiar su selección.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Sí, enviar',
          cancelButtonText: 'No, cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            // Mostrar animación de carga
            Swal.fire({
              title: 'Enviando...',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading() // Mostrar el spinner de carga
              }
            })
    
            // Agregar un delay de 3000 ms antes de enviar el formulario
            setTimeout(() => {
              form.submit() // Enviar el formulario después de 3 segundos
            }, 3000)
          }
        })
      })
    
      document.getElementById('submitBtn').addEventListener('click', function () {
        const form = document.getElementById('radicadoForm')
        const fileInput = document.getElementById('pdfFile')
    
        // Verificar si se ha seleccionado un archivo
        if (!fileInput.files.length) {
          Swal.fire({
            icon: 'error',
            title: 'Formulario incompleto',
            text: 'Por favor, complete todos los campos requeridos antes de enviar.'
          })
          return
        }
    
        // Mostrar alerta de confirmación
        Swal.fire({
          title: '¿Está seguro de que desea enviar?',
          text: 'Una vez enviado, no podrá cambiar su selección.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Sí, enviar',
          cancelButtonText: 'No, cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            // Mostrar animación de carga
            Swal.fire({
              title: 'Enviando...',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading() // Mostrar el spinner de carga
              }
            })
    
            // Agregar un delay de 3000 ms antes de enviar el formulario
            setTimeout(() => {
              form.submit() // Enviar el formulario después de 3 segundos
            }, 3000)
          }
        })
      })
    
      // Manejar el botón de enviar concepto
      document.querySelector('.btn-concepto').addEventListener('click', function () {
        const formConcepto = document.getElementById('formconcepto')
    
        formConcepto.style.position = 'fixed'
        formConcepto.style.top = '50%'
        formConcepto.style.left = '50%'
        formConcepto.style.transform = 'translate(-50%, -50%)'
        formConcepto.style.transition = 'opacity 0.5s'
        formConcepto.style.opacity = '1'
        formConcepto.style.zIndex = '1000'
      })
    
      // Manejar el botón de cerrar el formulario
      document.getElementById('btn-cerrar-concepto').addEventListener('click', function () {
        const formConcepto = document.getElementById('formconcepto')
        formConcepto.style.opacity = '0'
        formConcepto.style.transition = 'opacity 0.5s'
    
        setTimeout(() => {
          formConcepto.style.zIndex = '-1'
          formConcepto.style.position = 'absolute'
        }, 500)
      })
    
      // Manejar el envío del formulario de concepto
      document.getElementById('formconcepto').addEventListener('submit', function (event) {
        event.preventDefault() // Prevenir el envío predeterminado
    
        const form = event.target
    
        // Verificar si el formulario es válido
        if (!form.checkValidity()) {
          event.stopPropagation()
          form.classList.add('was-validated') // Mostrar errores de validación
          Swal.fire({
            icon: 'error',
            title: 'Formulario incompleto',
            text: 'Por favor, complete todos los campos requeridos antes de enviar.'
          })
          return
        }
    
        Swal.fire({
          title: '¿Está seguro de que desea enviar?',
          text: 'Una vez enviado, no podrá cambiar su selección.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Sí, enviar',
          cancelButtonText: 'No, cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            // Mostrar animación de carga
            Swal.fire({
              title: 'Enviando...',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading() // Mostrar el spinner de carga
              }
            })
    
            // Agregar un delay de 3000 ms antes de enviar el formulario
            setTimeout(() => {
              form.submit() // Enviar el formulario después de 3 segundos
            }, 3000)
          }
        })
      })
    })
  </script>
{% endblock %}
